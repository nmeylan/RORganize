(function(e){"use strict";var t=function(e){var t,r,i;t=function(){r=false};return function(){var t=n(arguments);if(r){i=t;return}r=true;var s=this;t.unshift(function o(){if(i){var t=i;i=undefined;t.unshift(o);e.apply(s,t)}else{r=false}});e.apply(this,t)}};var n=function(e){var t;t=Array.prototype.slice.call(e);return t};var r=function(){var t;t=e("<div></div>").css(["color"]).color;if(typeof t!=="undefined"){return function(e,t){return e.css(t)}}else{return function(t,n){var r;r={};e.each(n,function(e,n){r[n]=t.css(n)});return r}}}();var i=function(e){return e};var s=function(e){var t={};return function(n,r){if(t[n]){r(t[n])}else{e.call(this,n,function(e){t[n]=(t[n]||[]).concat(e);r.apply(null,arguments)})}}};var o=function(e,t){var n,r;if(e.indexOf)return e.indexOf(t)!=-1;for(n=0,r=e.length;n<r;n++){if(e[n]===t)return true}return false};var u=function(){function u(t,n){var r;this.el=t.get(0);r=this.el===document.activeElement;this.$el=t;this.id="textComplete"+o++;this.strategies=[];this.option=n;if(r){this.initialize();this.$el.focus()}else{this.$el.one("focus.textComplete",e.proxy(this.initialize,this))}}var n,i,s,o;n={list:'<ul class="dropdown-menu-text-complete"></ul>'};i={list:{position:"absolute",left:0,zIndex:"100",display:"none"}};s=e(n.list).css(i.list);o=0;e.extend(u.prototype,{initialize:function(){var t,n,r,i;t=s.clone();this.listView=new a(t,this);this.$el.on({"keyup.textComplete":e.proxy(this.onKeyup,this),"keydown.textComplete":e.proxy(this.listView.onKeydown,this.listView)});r=this.option.appendTo;if(r){this.listView.appendTo(r instanceof e?r:e(r))}else{this.listView.appendTo(e("body"))}i=this.option.height;if(i){t.css("overflow-y","auto");t.height(i)}n={};n["click."+this.id]=e.proxy(this.onClickDocument,this);n["keyup."+this.id]=e.proxy(this.onKeyupDocument,this);e(document).on(n)},register:function(e){this.strategies=this.strategies.concat(e)},renderList:function(e){if(this.clearAtNext){this.listView.clear();this.clearAtNext=false}if(e.length){this.listView.strategy=this.strategy;if(!this.listView.shown){this.listView.setPosition(this.getCaretPosition()).clear().activate()}e=e.slice(0,this.strategy.maxCount);this.listView.render(e)}if(!this.listView.data.length&&this.listView.shown){this.listView.deactivate()}},searchCallbackFactory:function(e){var t=this;return function(n,r){t.renderList(n);if(!r){e();t.clearAtNext=true}}},onKeyup:function(e){if(this.skipSearch(e)){return}this.trigger(null,true)},trigger:function(e,t){var n,r;e||(e=this.getTextFromHeadToCaret());n=this.extractSearchQuery(e);if(n.length){r=n[1];if(t&&this.term===r){return}this.term=r;this.search(n)}else{this.term=null;this.listView.deactivate()}},skipSearch:function(e){switch(e.keyCode){case 40:case 38:return true}if(e.ctrlKey)switch(e.keyCode){case 78:case 80:return true}},onSelect:function(t){var n,r,i,s,o,u,a;n=this.getTextFromHeadToCaret();a=n.length;if(this.el.isContentEditable){s=window.getSelection();o=s.getRangeAt(0);u=o.cloneRange();u.selectNodeContents(o.startContainer);var f=u.toString();r=f.substring(o.startOffset)}else{r=this.el.value.substring(this.el.selectionEnd)}i=this.strategy.replace(t);if(e.isArray(i)){r=i[1]+r;i=i[0]}n=n.replace(this.strategy.match,i);a=a-n.length;if(this.el.isContentEditable){for(var l=0;l<a;++l){document.execCommand("delete",false)}if(r){document.execCommand("insertHTML",false,r)}}else{this.$el.val(n+r);this.el.selectionStart=this.el.selectionEnd=n.length}this.$el.trigger("change").trigger("textComplete:select",t);this.el.focus()},onClickDocument:function(e){if(e.originalEvent&&!e.originalEvent.keepTextCompleteDropdown){this.listView.deactivate()}},onKeyupDocument:function(e){if(this.listView.shown&&e.keyCode===27){this.listView.deactivate();this.$el.focus()}},destroy:function(){this.$el.off(".textComplete");e(document).off("."+this.id);if(this.listView){this.listView.destroy()}this.$el.removeData("textComplete");this.$el=null},getCaretPosition:function(){var e,t;e=this.getCaretRelativePosition();t=this.$el.offset();e.top+=t.top;e.left+=t.left;return e},getCaretRelativePosition:function(){var t,n,i,s,o,u,a,f,l,c;if(!this.el.isContentEditable){t=["border-width","font-family","font-size","font-style","font-variant","font-weight","height","letter-spacing","word-spacing","line-height","text-decoration","text-align","width","padding-top","padding-right","padding-bottom","padding-left","margin-top","margin-right","margin-bottom","margin-left","border-style","box-sizing"];a=this.$el[0].scrollHeight>this.$el[0].offsetHeight;n=e.extend({position:"absolute",overflow:a?"scroll":"auto","white-space":"pre-wrap",top:0,left:-9999,direction:u},r(this.$el,t));i=e("<div></div>").css(n).text(this.getTextFromHeadToCaret());s=e("<span></span>").text(".").appendTo(i);this.$el.before(i);o=s.position();o.top+=s.height()-this.$el.scrollTop();i.remove()}else{f=window.getSelection().getRangeAt(0).cloneRange();l=document.createElement("span");f.insertNode(l);f.selectNodeContents(l);f.deleteContents();c=e(l);o=c.offset();o.left-=this.$el.offset().left;o.top+=c.height()-this.$el.offset().top}u=this.$el.attr("dir")||this.$el.css("direction");if(u==="rtl"){o.left-=this.listView.$el.width()}return o},getTextFromHeadToCaret:function(){var e,t,n;if(this.el.isContentEditable){if(window.getSelection){var n=window.getSelection().getRangeAt(0);var r=n.cloneRange();r.selectNodeContents(n.startContainer);e=r.toString().substring(0,n.startOffset)}}else{t=this.el.selectionEnd;if(typeof t==="number"){e=this.el.value.substring(0,t)}else if(document.selection){n=this.el.createTextRange();n.moveStart("character",0);n.moveEnd("textedit");e=n.text}}return e},extractSearchQuery:function(e){var t,n,r,i;for(t=0,n=this.strategies.length;t<n;t++){r=this.strategies[t];i=e.match(r.match);if(i){return[r,i[r.index]]}}return[]},search:t(function(e,t){var n;this.strategy=t[0];n=t[1];this.strategy.search(n,this.searchCallbackFactory(e))})});return u}();var a=function(){function t(t,n){this.data=[];this.$el=t;this.index=0;this.completer=n;if(n.option.listPosition){this.setPosition=n.option.listPosition}this.$el.on("mousedown.textComplete","li.textcomplete-item",e.proxy(this.onClick,this));this.$el.on("mouseover.textComplete","li.textcomplete-item",e.proxy(this.onMouseover,this))}e.extend(t.prototype,{shown:false,render:function(t){var n,r,i,s,u,a;n="";if(this.strategy.header){if(e.isFunction(this.strategy.header)){a=this.strategy.header(t)}else{a=this.strategy.header}n+='<li class="textcomplete-header">'+a+"</li>"}for(r=0,i=t.length;r<i;r++){u=t[r];if(o(this.data,u))continue;s=this.data.length;this.data.push(u);n+='<li class="textcomplete-item" data-index="'+s+'"><a>';n+=this.strategy.template(u);n+="</a></li>";if(this.data.length===this.strategy.maxCount)break}if(this.strategy.footer){if(e.isFunction(this.strategy.footer)){a=this.strategy.footer(t)}else{a=this.strategy.footer}n+='<li class="textcomplete-footer">'+a+"</li>"}this.$el.append(n);if(!this.data.length){this.deactivate()}else{this.activateIndexedItem();this.setScroll()}},clear:function(){this.data=[];this.$el.html("");this.index=0;return this},activateIndexedItem:function(){this.$el.find(".active").removeClass("active");this.getActiveItem().addClass("active")},getActiveItem:function(){return e(this.$el.children(".textcomplete-item").get(this.index))},activate:function(){if(!this.shown){this.$el.show();this.completer.$el.trigger("textComplete:show");this.shown=true}return this},deactivate:function(){if(this.shown){this.$el.hide();this.completer.$el.trigger("textComplete:hide");this.shown=false;this.data=[];this.index=null}return this},setPosition:function(e){var t;if(this.strategy.placement.indexOf("top")>-1){t=parseInt(this.$el.css("font-size"));e={top:"auto",bottom:this.$el.parent().height()-e.top+t,left:e.left}}else{e.bottom="auto"}if(this.strategy.placement.indexOf("absleft")>-1){e.left=0}if(this.strategy.placement.indexOf("absright")>-1){e.right=0;e.left="auto"}this.$el.css(e);return this},setScroll:function(e){var t=this.getActiveItem();var n=t.position().top;var r=t.outerHeight();var i=this.$el.innerHeight();var s=this.$el.scrollTop();if(this.index===0||this.index===this.data.length-1||n<0){this.$el.scrollTop(n+s)}else if(n+r>i){this.$el.scrollTop(n+r+s-i)}},select:function(e){var t=this;this.completer.onSelect(this.data[e]);setTimeout(function(){t.deactivate()},0)},onKeydown:function(t){if(!this.shown)return;var n=t.ctrlKey||t.altKey||t.metaKey||t.shiftKey;if(t.keyCode===38||t.ctrlKey&&t.keyCode===80){t.preventDefault();if(this.index===0){this.index=this.data.length-1}else{this.index-=1}this.activateIndexedItem();this.setScroll()}else if(t.keyCode===40||t.ctrlKey&&t.keyCode===78){t.preventDefault();if(this.index===this.data.length-1){this.index=0}else{this.index+=1}this.activateIndexedItem();this.setScroll()}else if(!n&&(t.keyCode===13||t.keyCode===9)){t.preventDefault();this.select(parseInt(this.getActiveItem().data("index"),10))}else if(t.keyCode===33){t.preventDefault();var r=0;var i=this.getActiveItem().position().top-this.$el.innerHeight();this.$el.children().each(function(t){if(e(this).position().top+e(this).outerHeight()>i){r=t;return false}});this.index=r;this.activateIndexedItem();this.setScroll()}else if(t.keyCode===34){t.preventDefault();var r=this.data.length-1;var i=this.getActiveItem().position().top+this.$el.innerHeight();this.$el.children().each(function(t){if(e(this).position().top>i){r=t;return false}});this.index=r;this.activateIndexedItem();this.setScroll()}},onClick:function(t){var n=e(t.target);t.preventDefault();t.originalEvent.keepTextCompleteDropdown=true;if(!n.hasClass("textcomplete-item")){n=n.parents("li.textcomplete-item")}this.select(parseInt(n.data("index"),10))},onMouseover:function(t){var n=e(t.target);t.preventDefault();if(!n.hasClass("textcomplete-item")){n=n.parents("li.textcomplete-item")}this.index=parseInt(n.data("index"),10);this.activateIndexedItem()},destroy:function(){this.deactivate();this.$el.off("click.textComplete").remove();this.$el=null},appendTo:function(e){e.css({position:"relative"}).append(this.$el)}});return t}();e.fn.textcomplete=function(t,n){var r,o,a,f;f="textComplete";n||(n={});if(t==="destroy"){return this.each(function(){var t=e(this).data(f);if(t){t.destroy()}})}for(r=0,o=t.length;r<o;r++){a=t[r];if(!a.template){a.template=i}if(a.index==null){a.index=2}if(a.placement==null){a.placement=""}if(a.cache){a.search=s(a.search)}a.maxCount||(a.maxCount=10)}return this.each(function(){var r,i;r=e(this);i=r.data(f);if(!i){i=new u(r,n);r.data(f,i)}i.register(t)})}})(window.jQuery||window.Zepto)